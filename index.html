<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Moments of Motherhood Recorder</title>
  <style>
    body {
      font-family: 'Cormorant Garamond', serif;
      text-align: center;
      background-color: #fffaf7;
      padding: 20px;
    }

    video, audio {
      margin: 20px auto;
      display: block;
      max-width: 90%;
      border-radius: 12px;
    }

    button {
      font-size: 16px;
      padding: 10px 20px;
      margin: 8px 4px;
      border-radius: 8px;
      border: none;
      background-color: #e0e0e0;
      cursor: pointer;
      transition: 0.3s;
    }

    button:disabled {
      background-color: #cccccc;
      cursor: not-allowed;
    }

    .hidden {
      display: none;
    }

    .status {
      font-size: 16px;
      margin-top: 10px;
    }
  </style>
</head>
<body>

  <!-- Logo -->
  <img src="https://res.cloudinary.com/dpsiwijyq/image/upload/v1754367073/Moments_of_Motherhood_upfwmb.png" alt="Moments of Motherhood Logo" width="160" />

  <h2>Record Your Moment</h2>

  <video id="preview" autoplay muted class="hidden"></video>
  <video id="playback" controls class="hidden"></video>

  <div class="status" id="statusText">Press start when you're ready.</div>

  <div>
    <button id="toggleCameraBtn">Turn Camera On</button>
    <button id="startBtn">Start Recording</button>
    <button id="stopBtn" disabled>Stop Recording</button>
    <button id="pauseBtn" disabled>Pause</button>
    <button id="deleteBtn" disabled>Delete</button>
    <button id="submitBtn" disabled>Submit</button>
  </div>

  <script>
    let mediaRecorder, chunks = [];
    let stream = null;
    let isRecording = false;
    let usingCamera = false;

    const preview = document.getElementById("preview");
    const playback = document.getElementById("playback");
    const toggleCameraBtn = document.getElementById("toggleCameraBtn");
    const startBtn = document.getElementById("startBtn");
    const pauseBtn = document.getElementById("pauseBtn");
    const stopBtn = document.getElementById("stopBtn");
    const deleteBtn = document.getElementById("deleteBtn");
    const submitBtn = document.getElementById("submitBtn");
    const statusText = document.getElementById("statusText");

    // Fully stop and clean up media stream
    function stopStreamTracks() {
      if (stream) {
        stream.getTracks().forEach(track => track.stop());
        stream = null;
        preview.srcObject = null;
        preview.classList.add("hidden");
        toggleCameraBtn.textContent = "Turn Camera On";
      }
    }

    // CAMERA TOGGLE
    toggleCameraBtn.onclick = async () => {
      if (stream) {
        stopStreamTracks();
        usingCamera = false;
        statusText.textContent = "Camera turned off.";
        return;
      }

      try {
        stream = await navigator.mediaDevices.getUserMedia({ video: true, audio: true });
        usingCamera = true;
        preview.srcObject = stream;
        preview.classList.remove("hidden");
        toggleCameraBtn.textContent = "Turn Camera Off";
        statusText.textContent = "Camera is on.";
      } catch (err) {
        alert("Could not access camera/audio: " + err.message);
        usingCamera = false;
        toggleCameraBtn.textContent = "Turn Camera On";
      }
    };

    // START RECORDING
    startBtn.onclick = async () => {
      if (!stream) {
        try {
          stream = await navigator.mediaDevices.getUserMedia({ audio: true });
          usingCamera = false;
          preview.classList.add("hidden");
          toggleCameraBtn.textContent = "Turn Camera On";
        } catch (err) {
          alert("Please allow microphone access.");
          return;
        }
      }

      chunks = [];
      mediaRecorder = new MediaRecorder(stream);
      mediaRecorder.ondataavailable = e => chunks.push(e.data);
      mediaRecorder.onstop = () => {
        const blob = new Blob(chunks, { type: "video/webm" });
        playback.src = URL.createObjectURL(blob);
        playback.classList.remove("hidden");
        preview.classList.add("hidden");
        submitBtn.disabled = false;
        statusText.textContent = "Recording complete. Review before submitting.";
      };

      mediaRecorder.start();
      isRecording = true;
      startBtn.disabled = true;
      pauseBtn.disabled = false;
      stopBtn.disabled = false;
      deleteBtn.disabled = false;
      toggleCameraBtn.disabled = true;
      statusText.textContent = "Recording...";
    };

    // PAUSE
    pauseBtn.onclick = () => {
      if (!mediaRecorder) return;
      if (mediaRecorder.state === "recording") {
        mediaRecorder.pause();
        pauseBtn.textContent = "Resume";
        statusText.textContent = "Paused.";
      } else if (mediaRecorder.state === "paused") {
        mediaRecorder.resume();
        pauseBtn.textContent = "Pause";
        statusText.textContent = "Recording...";
      }
    };

    // STOP
    stopBtn.onclick = () => {
      if (mediaRecorder && isRecording) {
        mediaRecorder.stop();
        isRecording = false;
        pauseBtn.disabled = true;
        stopBtn.disabled = true;
        startBtn.disabled = false;
        toggleCameraBtn.disabled = false;
      }
    };

    // DELETE
    deleteBtn.onclick = () => {
      chunks = [];
      playback.src = "";
      playback.classList.add("hidden");
      submitBtn.disabled = true;
      statusText.textContent = "Recording deleted. Ready to start again.";

      pauseBtn.disabled = true;
      stopBtn.disabled = true;
      startBtn.disabled = false;
      toggleCameraBtn.disabled = false;

      stopStreamTracks(); // kill any open tracks
    };

    // SUBMIT
    submitBtn.onclick = () => {
      statusText.textContent = "Redirecting...";
      window.location.href = "https://momentsofmotherhood.glide.page";
    };
  </script>

</body>
</html>
